{% extends "layout.html" %} {% block page_title %}Invoice #{{ transaction.id
}}{% endblock %} {% block head %}
<style>
  /* Styling khusus saat dicetak (Print Mode) */
  @media print {
    body * {
      visibility: hidden;
    }
    #printableArea,
    #printableArea * {
      visibility: visible;
    }
    #printableArea {
      position: absolute;
      left: 0;
      top: 0;
      width: 100%;
    }
    .no-print,
    .sidebar,
    header,
    .btn-toolbar,
    footer {
      display: none !important;
    }
    .card {
      border: none !important;
      box-shadow: none !important;
    }
    .card-header {
      display: none !important;
    }
  }
</style>
{% endblock %} {% block content %}
<div
  class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom no-print"
>
  <div>
    <h1 class="h2">Detail Transaksi</h1>
    <nav aria-label="breadcrumb">
      <ol class="breadcrumb">
        <li class="breadcrumb-item">
          <a href="{{ url_for('sales.transactions') }}">Riwayat</a>
        </li>
        <li class="breadcrumb-item active" aria-current="page">
          #{{ transaction.id }}
        </li>
      </ol>
    </nav>
  </div>
  <div class="btn-toolbar mb-2 mb-md-0">
    <div class="btn-group me-2">
      <a
        href="{{ url_for('sales.transactions') }}"
        class="btn btn-sm btn-outline-secondary"
      >
        <i class="fas fa-arrow-left me-1"></i> Kembali
      </a>
      <button
        type="button"
        class="btn btn-sm btn-primary"
        onclick="window.print()"
      >
        <i class="fas fa-print me-1"></i> Cetak Invoice
      </button>
    </div>
  </div>
</div>

<div class="row" id="printableArea">
  <div class="col-lg-8">
    <div class="card shadow mb-4">
      <div class="card-header py-3 bg-white no-print">
        <h6 class="m-0 fw-bold text-primary">Invoice Penjualan</h6>
      </div>
      <div class="card-body">
        <div class="row mb-4">
          <div class="col-6">
            <h4 class="fw-bold text-primary">TOKO MAJU JAYA</h4>
            <p class="small text-muted mb-0">
              Jl. Contoh Bisnis No. 123, Jakarta
            </p>
            <p class="small text-muted">Telp: 021-555-0199</p>
          </div>
          <div class="col-6 text-end">
            <h5 class="fw-bold">INVOICE #{{ transaction.id }}</h5>
            <p class="mb-0">
              Tgl: {{ transaction.created_at.strftime('%d/%m/%Y') }}
            </p>
            <p class="mb-0">
              Jam: {{ transaction.created_at.strftime('%H:%M') }} WIB
            </p>
            <p class="mb-0">
              Kasir: {{ transaction.user.username | capitalize if
              transaction.user else 'Admin' }}
            </p>
          </div>
        </div>

        <hr />

        <div class="row mb-4">
          <div class="col-md-6">
            <h6 class="fw-bold text-secondary">Ditagihkan Kepada:</h6>
            {% if transaction.customer %}
            <h5 class="fw-bold mb-1">{{ transaction.customer.name }}</h5>
            <p class="mb-0 small">
              <i class="fas fa-phone me-1"></i> {{ transaction.customer.phone or
              '-' }}
            </p>
            <p class="mb-0 small">
              <i class="fas fa-map-marker-alt me-1"></i> {{
              transaction.customer.address or '-' }}
            </p>
            {% else %}
            <h5 class="fw-bold mb-1">Pelanggan Umum</h5>
            <p class="mb-0 small text-muted">Non-Member</p>
            {% endif %}
          </div>
          <div class="col-md-6 text-md-end">
            <h6 class="fw-bold text-secondary">Metode Pembayaran:</h6>
            <span class="badge bg-light text-dark border p-2 fs-6">
              {{ transaction.payment_method | upper }}
            </span>
            {% if transaction.notes %}
            <div class="mt-2 text-muted small fst-italic">
              Catatan: "{{ transaction.notes }}"
            </div>
            {% endif %}
          </div>
        </div>

        <div class="table-responsive">
          <table class="table table-bordered align-middle">
            <thead class="table-light">
              <tr>
                <th>Produk</th>
                <th class="text-end">Harga Satuan</th>
                <th class="text-center">Qty</th>
                <th class="text-end">Subtotal</th>
              </tr>
            </thead>
            <tbody>
              {% set ns = namespace(gross_total=0) %} {% for item in
              transaction.items %} {% set line_total = item.price *
              item.quantity %} {% set ns.gross_total = ns.gross_total +
              line_total %}
              <tr>
                <td>{{ item.product.name }}</td>
                <td class="text-end">{{ item.price | rp }}</td>
                <td class="text-center">{{ item.quantity }}</td>
                <td class="text-end fw-bold">{{ line_total | rp }}</td>
              </tr>
              {% endfor %}
            </tbody>
            <tfoot>
              <tr>
                <th colspan="3" class="text-end">Subtotal</th>
                <th class="text-end">{{ ns.gross_total | rp }}</th>
              </tr>

              {% if transaction.discount_amount > 0 %}
              <tr class="text-danger">
                <th colspan="3" class="text-end">Diskon / Promo</th>
                <th class="text-end">
                  - {{ transaction.discount_amount | rp }}
                </th>
              </tr>
              {% endif %}

              <tr class="table-primary">
                <th colspan="3" class="text-end h5">TOTAL BAYAR</th>
                <th class="text-end h5">{{ transaction.total_amount | rp }}</th>
              </tr>
            </tfoot>
          </table>
        </div>

        <div class="text-center mt-5 mb-3 no-print">
          <p class="text-muted small">Terima kasih atas kunjungan Anda.</p>
        </div>
      </div>
    </div>
  </div>

  <div class="col-lg-4 no-print">
    <div class="card shadow mb-4">
      <div class="card-header py-3 bg-white">
        <h6 class="m-0 fw-bold text-primary">Ringkasan Statistik</h6>
      </div>
      <div class="card-body">
        <div class="d-flex justify-content-between mb-2">
          <span>Jenis Produk:</span>
          <strong>{{ transaction.items | length }} Item</strong>
        </div>
        <div class="d-flex justify-content-between mb-2">
          <span>Total Barang:</span>
          {% set total_qty = transaction.items | sum(attribute='quantity') %}
          <strong>{{ total_qty }} Pcs</strong>
        </div>
        <hr />
        <div class="d-flex justify-content-between">
          <span>Status:</span>
          <span class="badge bg-success">LUNAS</span>
        </div>
      </div>
    </div>

    {% if transaction.customer %}
    <div class="card shadow mb-4">
      <div class="card-header py-3 bg-white">
        <h6 class="m-0 fw-bold text-primary">Analisis Pelanggan</h6>
      </div>
      <div class="card-body" id="customerSegments">
        <div class="d-flex justify-content-center">
          <div
            class="spinner-border text-primary spinner-border-sm"
            role="status"
          ></div>
          <span class="ms-2 small">Memuat data AI...</span>
        </div>
      </div>
    </div>
    {% endif %}
  </div>
</div>
{% endblock %} {% block scripts %}
<script>
  $(document).ready(function() {
      {% if transaction.customer %}
      // Load customer segments via AJAX
      $.ajax({
          url: `/sales/api/customer-segments/{{ transaction.customer.id }}`,
          method: 'GET',
          success: function(data) {
              let html = '';

              if (data.segments.length > 0) {
                  html += '<h6 class="small font-weight-bold text-muted mb-2">Segmen K-Means:</h6>';
                  data.segments.forEach(function(segment) {
                      html += `
                          <div class="mb-2 p-2 border rounded" style="border-left: 4px solid ${segment.color} !important;">
                              <div class="fw-bold" style="color: ${segment.color}">${segment.name}</div>
                              <div class="small text-muted">${segment.description}</div>
                          </div>
                      `;
                  });
              } else {
                  html = '<div class="alert alert-warning small">Pelanggan ini belum masuk analisis K-Means periode terakhir.</div>';
              }

              $('#customerSegments').html(html);
          },
          error: function() {
              $('#customerSegments').html('<p class="text-danger small">Gagal memuat informasi segmen.</p>');
          }
      });
      {% endif %}
  });
</script>
{% endblock %}
